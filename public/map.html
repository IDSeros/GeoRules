<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>GeoRules</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/x-icon" href="GeoRulelogo.png" />
  </head>
  <body>
    <button id="backButton" onclick="goBack()">&#8592;</button>
    <button id="addLocationBtn" onclick="openAddLocationModal()">+</button>
    <div id="statusPanel">
      <h2>Mi ubicación</h2>
      <p id="status">Obteniendo ubicación...</p>
    </div>
    
    <!-- MAPA | NO TOCAR -->
    <div id="map"></div> 
    <!-- MAPA | NO TOCAR -->

    <!-- Panel de detalles -->
    <div id="infoPanel">
      <h3 id="panelTitle">Detalles</h3>
      <p class="info" id="addressPanel"></p>
      <p class="info" id="establishmentPanel"></p>
      <p class="info" id="extinguishPanel"></p>
      <p class="info" id="firstAidPanel"></p>
      <p class="info" id="sprinklerPanel"></p>
      <p class="info" id="emergenExitPanel"></p>
      <p class="info" id="inspectionPanel"></p>
      <p class="info" id="accessPanel"></p>

      <!-- Botón de favoritos dentro del panel -->
      <button id="toggleFavorite">☆ Añadir a favoritos</button>

      <button id="closePanel" onclick="closePanel()">X</button>
    </div>

    <!-- Botón flotante -->
    <button id="favButton">★</button>

    <!-- Panel de favoritos -->
    <div id="favoritesPanel">
      <h3>Mis Favoritos</h3>
      <div id="favoritesList"></div>
    </div>

    <!-- ----------------- Modal: Registrar Ubicación ----------------- -->
    <div id="modal" class="modal" style="display:none;">
      <div class="modal-content" role="dialog" aria-hidden="true">
        <!-- Add Location view -->
        <div id="add-location-view" style="display: none;">
          <h3>Registrar nueva ubicación</h3>
          <form id="add-location-form">
            <div class="form-group">
              <label for="loc-nombre">Nombre</label>
              <input id="loc-nombre" type="text" required placeholder="Nombre del lugar...">
            </div>

            <div class="form-group">
              <label for="loc-direccion">Dirección</label>
              <input id="loc-direccion" type="text" required placeholder="Calle, número, colonia...">
            </div>

            <div class="form-group">
              <label for="loc-tipo">Tipo de establecimiento</label>
              <select id="loc-tipo" required>
                <option value="">-- Selecciona un tipo --</option>
                <option>Oficina</option>
                <option>Planta / Industria</option>
                <option>Comercio</option>
                <option>Escuela</option>
                <option>Hospital / Clínica</option>
                <option>Residencial</option>
                <option>Otro</option>
              </select>
            </div>

            <div class="form-group">
              <label for="loc-numext">Número de extintores</label>
              <input id="loc-numext" type="number" min="0" value="0">
            </div>

            <div class="form-group">
              <label>¿Hay botiquín?</label>
              <div>
                <label><input type="radio" name="loc-botiquin" value="true" checked> Sí</label>
                <label style="margin-left:1rem;"><input type="radio" name="loc-botiquin" value="false"> No</label>
              </div>
            </div>

            <div class="form-group">
              <label>¿Hay rociadores?</label>
              <div>
                <label><input type="radio" name="loc-rociadores" value="true"> Sí</label>
                <label style="margin-left:1rem;"><input type="radio" name="loc-rociadores" value="false" checked> No</label>
              </div>
            </div>

            <div class="form-group">
              <label for="loc-numsalidas">Número de salidas de emergencia</label>
              <input id="loc-numsalidas" type="number" min="0" value="0">
            </div>

            <div class="form-group">
              <label for="loc-ultimainspeccion">Fecha de última inspección</label>
              <input id="loc-ultimainspeccion" type="date">
            </div>

            <div class="form-group">
              <label for="loc-encargado">Encargado de seguridad</label>
              <select id="loc-encargado">
                <option value="">-- Selecciona encargado --</option>
                <!-- Se llena dinámicamente vía JS -->
              </select>
            </div>

            <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem">
              <button type="button" id="close-modal-addlocation" class="btn" style="background:#e2e8f0;color:#0f172a">Cancelar</button>
              <button type="submit" class="btn">Guardar ubicación</button>
            </div>
          </form>
        </div>
      </div>
    </div>


    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="map.js"></script>
    <script src="/js/location.js" defer></script>
    <script>
      async function fetchMe() {
        const token = localStorage.getItem("token");
        if (!token) return null;
        try {
          const res = await fetch("/api/me", {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (!res.ok) return null;
          return await res.json(); // { id, nombre, correo, rol }
        } catch (err) {
          console.error(err);
          return null;
        }
      }

      async function toggleAdminButton() {
        const adminBtn = document.getElementById("addLocationBtn");
        if (!adminBtn) return;
        const me = await fetchMe();
        if (me && me.rol === "admin") adminBtn.style.display = "block";
        else adminBtn.style.display = "none";
      }

      document.addEventListener("DOMContentLoaded", toggleAdminButton);
    </script>
  </body>
</html>
