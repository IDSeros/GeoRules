<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>GeoRules</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/x-icon" href="GeoRulelogo.png" />
  </head>
  <body>
    <button id="goBack">&#8592;</button>
    <button id="addLocationBtn">+</button>
    <div id="statusPanel">
      <h2>Mi ubicaci√≥n</h2>
      <p id="status">Obteniendo ubicaci√≥n...</p>
    </div>
    
    <!-- MAPA | NO TOCAR -->
    <div id="map"></div> 
    <!-- MAPA | NO TOCAR -->

    <!-- Panel de detalles -->
    <div id="infoPanel">
      <div id="dragHandle"></div>
      <h3 id="panelTitle">Detalles</h3>  
      <p class="info" id="addressPanel"></p>
      <p class="info" id="establishmentPanel"></p>
      <p class="info" id="extinguishPanel"></p>
      <p class="info" id="firstAidPanel"></p>
      <p class="info" id="sprinklerPanel"></p>
      <p class="info" id="emergenExitPanel"></p>
      <p class="info" id="inspectionPanel"></p>

      <!-- Bot√≥n de favoritos dentro del panel -->
      <button id="toggleFavorite">‚òÜ A√±adir a favoritos</button>

      <button id="closePanel">X</button>

      <button id="deleteLocationBtn">üóë</button>

    </div>

    <!-- Bot√≥n flotante -->
    <button id="favButton">‚òÖ</button>

    <!-- Panel de favoritos -->
    <div id="favoritesPanel">
      <h3>Mis Favoritos</h3>
      <div id="favoritesList"></div>
    </div>

    <!-- ----------------- Modal: Registrar Ubicaci√≥n ----------------- -->
    <div id="modal" class="modal">
      <div class="modal-content" role="dialog">
        <!-- Add Location view -->
        <div id="add-location-view">
          <h3>Registrar nueva ubicaci√≥n</h3>
          <form id="add-location-form">
            <div class="form-group">
              <label for="loc-nombre">Nombre</label>
              <input id="loc-nombre" type="text" required placeholder="Nombre del lugar...">
            </div>

            <div class="form-group">
              <label for="loc-direccion">Direcci√≥n</label>
              <input id="loc-direccion" type="text" required placeholder="Calle, n√∫mero, colonia...">
            </div>

            <div class="form-group">
              <label for="loc-tipo">Tipo de establecimiento</label>
              <select id="loc-tipo" required>
                <option value="">-- Selecciona un tipo --</option>
                <option>Oficina</option>
                <option>Planta / Industria</option>
                <option>Comercio</option>
                <option>Escuela</option>
                <option>Hospital / Cl√≠nica</option>
                <option>Residencial</option>
                <option>Otro</option>
              </select>
            </div>

            <div class="form-group">
              <label for="loc-numext">N√∫mero de extintores</label>
              <input id="loc-numext" type="number" min="0" value="0">
            </div>

            <div class="form-group">
              <label>¬øHay botiqu√≠n?</label>
              <div>
                <label><input type="radio" name="loc-botiquin" value="true" checked> S√≠</label>
                <label class="ml-1rem"><input type="radio" name="loc-botiquin" value="false"> No</label>
              </div>
            </div>

            <div class="form-group">
              <label>¬øHay rociadores?</label>
              <div>
                <label><input type="radio" name="loc-rociadores" value="true"> S√≠</label>
                <label class="ml-1rem"><input type="radio" name="loc-rociadores" value="false" checked> No</label>
              </div>
            </div>

            <div class="form-group">
              <label for="loc-numsalidas">N√∫mero de salidas de emergencia</label>
              <input id="loc-numsalidas" type="number" min="0" value="0">
            </div>

            <div class="form-group">
              <label for="loc-ultimainspeccion">Fecha de √∫ltima inspecci√≥n</label>
              <input id="loc-ultimainspeccion" type="date">
            </div>

            <div class="form-group">
              <label for="loc-encargado">Encargado de seguridad</label>
              <select id="loc-encargado">
                <option value="">-- Selecciona encargado --</option>
                <!-- Se llena din√°micamente v√≠a JS -->
              </select>
            </div>

            <div class="form-actions">
              <button type="button" id="close-modal-addlocation" class="btn cancel">Cancelar</button>
              <button type="submit" class="btn">Guardar ubicaci√≥n</button>
            </div>
          </form>
        </div>
      </div>
    </div>


    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script type="module" src="map.js"></script>
    <script>

      async function fetchMe() {
        const token = localStorage.getItem("token");
        if (!token) return null;
        try {
          const res = await fetch("/api/me", {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (!res.ok) return null;
          return await res.json(); // { id, nombre, correo, rol }
        } catch (err) {
          console.error(err);
          return null;
        }
      }

      async function toggleAdminButton() {
        const adminBtn = document.getElementById("addLocationBtn");
        if (!adminBtn) return;
        const me = await fetchMe();
        if (me && me.rol === "admin") adminBtn.style.display = "block";
        else adminBtn.style.display = "none";
      }

      //Si el usaurio es admin se mostrar√° el bot√≥n de borrar ubicaci√≥n
      async function toggleAdminFeatures() {
        const me = await fetchMe();
        const deleteBtn = document.getElementById("deleteLocationBtn");
        if (me && me.rol === "admin") {
          deleteBtn.style.display = "block";
        } else {
          deleteBtn.style.display = "none";
        }
      }
      
      document.addEventListener("DOMContentLoaded", toggleAdminFeatures);


      document.addEventListener("DOMContentLoaded", toggleAdminButton);

      (function() {
        const addView = document.getElementById("add-location-view");
        const addForm = document.getElementById("add-location-form");
        const encargadoSelect = document.getElementById("loc-encargado");
        const openAddBtn = document.getElementById("addLocationBtn"); // bot√≥n que abre modal
        const closeAddBtn = document.getElementById("close-modal-addlocation");

        // helper token
        function getToken() {
          return localStorage.getItem("token");
        }

        // abrir modal mostrando esta vista
        function openAddLocationModal() {
          const modal = document.getElementById("modal");
          if (!modal) return;
          modal.style.display = "flex";
          modal.setAttribute("aria-hidden", "false");

          // esconder otras vistas (login/signup) ‚Äî forma segura
          const loginViewEl = document.getElementById("login-view");
          if (loginViewEl) loginViewEl.style.display = "none";
          const signupViewEl = document.getElementById("signup-view");
          if (signupViewEl) signupViewEl.style.display = "none";

          addView.style.display = "block";

          // cargar encargados al abrir
          loadEncargados();
          document.getElementById("loc-nombre").focus();
        }


        function closeModal() {
          const modal = document.getElementById("modal");
          if (!modal) return;
          modal.style.display = "none";
          modal.setAttribute("aria-hidden", "true");
          addForm.reset();
          encargadoSelect.innerHTML = '<option value="">-- Selecciona encargado --</option>';
        }

        // Traer encargados desde backend
        async function loadEncargados() {
          const token = getToken();
          if (!token) {
            console.warn("No token: no se cargar√°n encargados");
            return;
          }
          try {
            const res = await fetch("/api/encargados", {
              headers: { Authorization: `Bearer ${token}` }
            });
            if (!res.ok) {
              console.error("No se pudieron obtener encargados");
              return;
            }
            const data = await res.json();
            encargadoSelect.innerHTML = '<option value="">-- Selecciona encargado --</option>';
            for(const e of data) {
              const opt = document.createElement("option");
              opt.value = e.id;
              opt.textContent = e.nombre;
              encargadoSelect.appendChild(opt);
            };
          } catch (err) {
            console.error("loadEncargados error", err);
          }
        }

        // Enviar formulario
        addForm?.addEventListener("submit", async function(e) {
          e.preventDefault();
          const token = getToken();
          if (!token) {
            alert("Debes iniciar sesi√≥n para registrar una ubicaci√≥n.");
            return;
          }

          // recoger valores
          const payload = {
            nombre: document.getElementById("loc-nombre").value.trim(),
            direccion: document.getElementById("loc-direccion").value.trim(),
            tipoestablecimiento: document.getElementById("loc-tipo").value,
            numextintores: Number.parseInt(document.getElementById("loc-numext").value || "0", 10),
            haybotiquin: document.querySelector('input[name="loc-botiquin"]:checked').value === "true",
            hayrociadores: document.querySelector('input[name="loc-rociadores"]:checked').value === "true",
            numemergenexits: Number.parseInt(document.getElementById("loc-numsalidas").value || "0", 10),
            ultimainspeccion: document.getElementById("loc-ultimainspeccion").value || null,
            idencargado: document.getElementById("loc-encargado").value || null
          };

          // Validaciones m√≠nimas
          if (!payload.nombre || !payload.direccion || !payload.tipoestablecimiento) {
            alert("Por favor completa Nombre, Direcci√≥n y Tipo de establecimiento.");
            return;
          }

          try {
            const res = await fetch("/api/addLocation", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`
              },
              body: JSON.stringify(payload)
            });

            const data = await res.json();
            if (res.ok || res.status === 201) {
              alert("‚úÖ Ubicaci√≥n registrada correctamente.");
              // opcional: refrescar el mapa o la lista de ubicaciones
              if (typeof globalThis.refreshLocations === "function") {
                globalThis.refreshLocations(); // si tienes una funci√≥n que recarga ubicaciones
              }
              closeModal();
            } else {
              alert("‚ùå Error: " + (data.error || "No se pudo guardar la ubicaci√≥n."));
            }
          } catch (err) {
            console.error("Error guardando ubicaci√≥n:", err);
            alert("‚ùå Error de conexi√≥n al servidor.");
          }
        });

        // listeners para abrir/cerrar
        openAddBtn?.addEventListener("click", openAddLocationModal);
        closeAddBtn?.addEventListener("click", closeModal);

        // cerrar modal al click fuera (si usas el mismo #modal)
        const modalElem = document.getElementById("modal");
        modalElem?.addEventListener("click", (e) => {
          if (e.target === modalElem) closeModal();
        });

      //Eliminar ubicaci√≥n
      document.getElementById("deleteLocationBtn").addEventListener("click", async () => {
        const locationId = globalThis.currentLocationId; //este id lo asignas cuando abres un panel
        if (!locationId) return alert("No se encontr√≥ la ubicaci√≥n.");
        
        const token = localStorage.getItem("token");
        if (!token) return alert("No est√°s autenticado.");
        
        if (!confirm("¬øSeguro que quieres eliminar esta ubicaci√≥n?")) return;
        
        const res = await fetch(`/api/locations/${locationId}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (res.ok) {
          alert("Ubicaci√≥n eliminada.");
          location.reload(); // refrescar mapa y lista
        } else {
          alert("Error al eliminar la ubicaci√≥n.");
        }
      });


      })();
    </script>
  </body>
</html>
